<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TranscodeHub | Ultra</title>

    <!-- Service Worker Fix -->
    <script src="coi-serviceworker.js"></script>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap"
      rel="stylesheet"
    />

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://unpkg.com/vanilla-tilt@1.7.0/dist/vanilla-tilt.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- FFmpeg Stable -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              cyber: "#00f3ff", // Cyan
              plasma: "#bc13fe", // Purple
              void: "#050508",
              panel: "rgba(15, 15, 20, 0.7)",
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              headers: ["Orbitron", "sans-serif"],
              mono: ["Share Tech Mono", "monospace"],
            },
            boxShadow: {
              glow: "0 0 20px rgba(0, 243, 255, 0.2)",
              "glow-strong": "0 0 40px rgba(0, 243, 255, 0.4)",
              "glow-red": "0 0 20px rgba(255, 0, 80, 0.4)",
            },
            backgroundImage: {
              "grid-pattern":
                "linear-gradient(to right, #1f1f1f 1px, transparent 1px), linear-gradient(to bottom, #1f1f1f 1px, transparent 1px)",
            },
          },
        },
      };
    </script>

    <style>
      body {
        background-color: #050508;
        color: #eee;
        overflow-x: hidden;
      }

      /* Loader */
      #app-loader {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: #000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      /* Glassmorphism */
      .glass-panel {
        background: rgba(10, 10, 12, 0.6);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
      }

      /* Responsive TV Frame */
      .cyber-frame {
        position: relative;
        background: #000;
        border: 2px solid #333;
        box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.9);
        overflow: hidden;
        /* Responsive Aspect Ratio */
        width: 100%;
        aspect-ratio: 16/9;
      }
      /* Corner Accents */
      .corner {
        position: absolute;
        width: 20px;
        height: 20px;
        border: 2px solid #00f3ff;
        transition: 0.3s;
      }
      .tl {
        top: 0;
        left: 0;
        border-right: 0;
        border-bottom: 0;
      }
      .tr {
        top: 0;
        right: 0;
        border-left: 0;
        border-bottom: 0;
      }
      .bl {
        bottom: 0;
        left: 0;
        border-right: 0;
        border-top: 0;
      }
      .br {
        bottom: 0;
        right: 0;
        border-left: 0;
        border-top: 0;
      }
      .cyber-frame:hover .corner {
        width: 30px;
        height: 30px;
        box-shadow: 0 0 10px #00f3ff;
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #000;
      }
      ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #00f3ff;
      }

      /* Toggle Switch */
      .toggle-checkbox:checked {
        right: 0;
        border-color: #00f3ff;
      }
      .toggle-checkbox:checked + .toggle-label {
        background-color: #00f3ff;
      }

      /* Mobile Menu Animation */
      .mobile-menu-overlay {
        clip-path: circle(0% at 0% 0%);
        transition: clip-path 0.7s cubic-bezier(0.77, 0, 0.175, 1);
      }
      .mobile-menu-overlay.active {
        clip-path: circle(150% at 0% 0%);
      }
    </style>
  </head>
  <body>
    <!-- Loading Screen -->
    <div id="app-loader">
      <div class="relative w-24 h-24 mb-4">
        <div
          class="absolute inset-0 border-4 border-cyber/20 rounded-full"
        ></div>
        <div
          class="absolute inset-0 border-4 border-cyber rounded-full border-t-transparent animate-spin"
        ></div>
        <i
          class="fas fa-microchip absolute inset-0 flex items-center justify-center text-cyber text-2xl animate-pulse"
        ></i>
      </div>
      <h2 class="font-headers text-2xl tracking-widest text-white">
        SYSTEM <span class="text-cyber">BOOT</span>
      </h2>
      <p class="font-mono text-gray-500 text-sm mt-2">Loading WASM Core...</p>
    </div>

    <!-- Background -->
    <canvas id="bg-canvas" class="fixed inset-0 z-[-1] opacity-60"></canvas>
    <div
      class="fixed inset-0 z-[-1] bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImEiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTTAgNDBMMzAgMEgyMGwtMjAgNDB6bTQwIDBMMzAgMEgyMGwyMCA0MHoiIGZpbGw9IiMzMzMiIGZpbGwtb3BhY2l0eT0iMC4wNSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNhKSIvPjwvc3ZnPg==')] opacity-20"
    ></div>

    <!-- Navbar -->
    <nav
      class="fixed top-0 w-full z-50 px-4 md:px-8 py-4 glass-panel border-b-0"
    >
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <!-- Logo -->
        <div class="flex items-center gap-3 group cursor-pointer">
          <div
            class="relative w-10 h-10 bg-cyber/10 rounded border border-cyber flex items-center justify-center overflow-hidden"
          >
            <div
              class="absolute inset-0 bg-cyber/20 translate-y-full group-hover:translate-y-0 transition duration-300"
            ></div>
            <i class="fas fa-bolt text-cyber text-xl relative z-10"></i>
          </div>
          <div class="flex flex-col">
            <span
              class="font-headers font-bold text-lg leading-none tracking-wider text-white"
              >TRANSCODE<span class="text-cyber">HUB</span></span
            >
            <span class="font-mono text-[10px] text-gray-400"
              >V.2.4.0 STABLE</span
            >
          </div>
        </div>

        <!-- Hamburger -->
        <button
          id="menu-btn"
          class="z-50 w-10 h-10 flex flex-col justify-center gap-1.5 group"
        >
          <span
            class="block w-8 h-0.5 bg-white transition-transform group-hover:bg-cyber origin-right"
            id="bar1"
          ></span>
          <span
            class="block w-6 h-0.5 bg-white transition-transform group-hover:bg-cyber ml-auto"
            id="bar2"
          ></span>
          <span
            class="block w-8 h-0.5 bg-white transition-transform group-hover:bg-cyber origin-right"
            id="bar3"
          ></span>
        </button>
      </div>
    </nav>

    <!-- Mobile Menu -->
    <div
      id="mobile-menu"
      class="mobile-menu-overlay fixed inset-0 bg-void z-40 flex flex-col justify-center items-center gap-8 glass-panel"
    >
      <a
        href="#"
        class="font-headers text-4xl hover:text-cyber hover:tracking-widest transition-all"
        >HOME</a
      >
      <a
        href="#studio"
        class="font-headers text-4xl hover:text-cyber hover:tracking-widest transition-all"
        >STUDIO</a
      >
      <a
        href="#guide"
        class="font-headers text-4xl hover:text-cyber hover:tracking-widest transition-all"
        >GUIDE</a
      >
    </div>

    <!-- Main Content -->
    <main class="pt-32 pb-20 px-4 md:px-8 max-w-7xl mx-auto">
      <!-- Hero Section -->
      <div class="grid md:grid-cols-2 gap-12 items-center mb-24">
        <div class="space-y-6">
          <div
            class="inline-block px-3 py-1 border border-cyber/30 bg-cyber/5 rounded text-cyber text-xs font-mono mb-2 animate-pulse"
          >
            ● BROWSER-BASED PROCESSING
          </div>
          <h1
            class="font-headers text-5xl md:text-7xl font-black text-white leading-tight"
          >
            COMPRESS <br />
            <span
              class="text-transparent bg-clip-text bg-gradient-to-r from-cyber to-blue-600"
              >WITHOUT LIMITS</span
            >
          </h1>
          <p
            class="font-mono text-gray-400 text-sm md:text-base max-w-md leading-relaxed"
          >
            High-performance video engine powered by WebAssembly. No upload
            limits. No server wait times. 100% Privacy.
          </p>
          <div class="flex gap-4 pt-4">
            <button
              onclick="document.getElementById('studio').scrollIntoView()"
              class="px-8 py-3 bg-cyber text-void font-bold font-headers skew-x-[-10deg] hover:bg-white hover:shadow-glow transition"
            >
              <span class="block skew-x-[10deg]">START ENGINE</span>
            </button>
            <button
              onclick="document.getElementById('guide').scrollIntoView()"
              class="px-8 py-3 border border-gray-600 text-white font-bold font-headers skew-x-[-10deg] hover:border-cyber hover:text-cyber transition"
            >
              <span class="block skew-x-[10deg]">TUTORIAL</span>
            </button>
          </div>
        </div>

        <!-- 3D Card Display -->
        <div class="relative h-[400px] w-full hidden md:block" id="hero-gfx">
          <!-- Cards injected by JS -->
        </div>
      </div>

      <!-- STUDIO SECTION -->
      <section id="studio" class="scroll-mt-24">
        <div class="glass-panel rounded-2xl p-1 overflow-hidden relative">
          <!-- Top Decor -->
          <div
            class="h-1 w-full bg-gradient-to-r from-transparent via-cyber to-transparent opacity-50"
          ></div>

          <div class="grid lg:grid-cols-12 gap-0">
            <!-- Left Panel: Controls -->
            <div
              class="lg:col-span-4 bg-void/50 p-6 md:p-8 border-r border-white/5 space-y-6"
            >
              <h3
                class="font-headers text-xl text-white flex items-center gap-2"
              >
                <i class="fas fa-sliders-h text-cyber"></i> CONFIG
              </h3>

              <!-- File Status -->
              <div
                id="file-status"
                class="hidden p-4 rounded bg-white/5 border-l-2 border-cyber"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-[10px] text-gray-400 font-mono uppercase">
                      Target File
                    </p>
                    <p id="fname" class="text-sm font-bold truncate w-40">
                      video.mp4
                    </p>
                  </div>
                  <span id="fsize" class="text-cyber font-mono text-xs"
                    >0MB</span
                  >
                </div>
              </div>

              <!-- Options -->
              <div class="space-y-4">
                <!-- Compression -->
                <div
                  class="group p-4 rounded border border-white/5 hover:border-cyber/30 transition bg-black/20"
                >
                  <label
                    class="flex items-center justify-between cursor-pointer"
                  >
                    <span class="font-bold text-sm">Compression</span>
                    <input
                      type="checkbox"
                      id="opt-compress"
                      class="accent-cyber w-5 h-5"
                    />
                  </label>
                  <p class="text-[10px] text-gray-500 mt-1">
                    Reduces bitrate (CRF 28).
                  </p>
                </div>

                <!-- Speed Mode (CRITICAL FIX) -->
                <div
                  class="group p-4 rounded border border-cyber/50 bg-cyber/5 hover:bg-cyber/10 transition"
                >
                  <label
                    class="flex items-center justify-between cursor-pointer"
                  >
                    <span class="font-bold text-sm text-cyber"
                      ><i class="fas fa-bolt mr-1"></i> Turbo Mode (720p)</span
                    >
                    <input
                      type="checkbox"
                      id="opt-speed"
                      class="accent-cyber w-5 h-5"
                      checked
                    />
                  </label>
                  <p class="text-[10px] text-gray-400 mt-1">
                    Downscales large videos for 5x faster processing.
                    Recommended for files > 50MB.
                  </p>
                </div>

                <!-- Format -->
                <div
                  class="group p-4 rounded border border-white/5 hover:border-cyber/30 transition bg-black/20"
                >
                  <label
                    class="flex items-center justify-between cursor-pointer"
                  >
                    <span class="font-bold text-sm">Convert Format</span>
                    <input
                      type="checkbox"
                      id="opt-convert"
                      class="accent-cyber w-5 h-5"
                      onchange="document.getElementById('fmt-select').classList.toggle('hidden')"
                    />
                  </label>
                  <select
                    id="fmt-select"
                    class="hidden mt-2 w-full bg-void border border-gray-700 text-xs p-2 rounded text-gray-300 outline-none focus:border-cyber"
                  >
                    <option value="mp4">MP4 (Standard)</option>
                    <option value="webm">WebM (Web)</option>
                    <option value="avi">AVI</option>
                  </select>
                </div>
              </div>

              <button
                id="process-btn"
                class="w-full py-4 bg-gray-800 text-gray-500 font-headers font-bold rounded cursor-not-allowed transition-all duration-300"
                disabled
              >
                AWAITING INPUT
              </button>
            </div>

            <!-- Right Panel: Visualizer -->
            <div
              class="lg:col-span-8 p-6 md:p-8 bg-black/40 flex flex-col justify-center"
            >
              <div class="cyber-frame group">
                <!-- Input Layer -->
                <input
                  type="file"
                  id="video-input"
                  class="absolute inset-0 w-full h-full opacity-0 z-20 cursor-pointer"
                  accept="video/*"
                />

                <!-- Decor -->
                <div class="corner tl"></div>
                <div class="corner tr"></div>
                <div class="corner bl"></div>
                <div class="corner br"></div>

                <!-- STATE 1: IDLE -->
                <div
                  id="ui-idle"
                  class="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 group-hover:scale-105 pointer-events-none"
                >
                  <i
                    class="fas fa-cloud-upload-alt text-6xl text-gray-700 mb-4 group-hover:text-cyber transition-colors"
                  ></i>
                  <h3 class="font-headers text-2xl">INITIATE UPLOAD</h3>
                  <p class="font-mono text-xs text-gray-500 mt-2">
                    DRAG FILE OR CLICK TO SCAN
                  </p>
                </div>

                <!-- STATE 2: PROCESSING -->
                <div
                  id="ui-process"
                  class="hidden absolute inset-0 bg-void/90 z-30 flex flex-col items-center justify-center"
                >
                  <div class="w-64 relative">
                    <div
                      class="flex justify-between font-mono text-xs text-cyber mb-1"
                    >
                      <span>ENCODING</span>
                      <span id="progress-txt">0%</span>
                    </div>
                    <div class="h-1 bg-gray-800 w-full overflow-hidden">
                      <div
                        id="progress-bar"
                        class="h-full bg-cyber w-0 shadow-[0_0_10px_#00f3ff]"
                      ></div>
                    </div>
                  </div>
                  <p
                    class="font-mono text-[10px] text-gray-500 mt-4 animate-pulse"
                  >
                    DO NOT CLOSE WINDOW
                  </p>

                  <!-- Terminal Log -->
                  <div
                    id="terminal"
                    class="mt-6 w-[80%] h-24 bg-black border border-gray-800 p-2 overflow-y-auto font-mono text-[10px] text-green-500 opacity-80"
                  >
                    <div>> System initialized...</div>
                  </div>
                </div>

                <!-- STATE 3: SUCCESS -->
                <div
                  id="ui-success"
                  class="hidden absolute inset-0 bg-void/95 z-30 flex flex-col items-center justify-center"
                >
                  <h2
                    class="font-headers text-3xl text-cyber mb-6 tracking-widest"
                  >
                    TASK COMPLETE
                  </h2>

                  <div
                    class="flex items-center gap-8 mb-8 bg-white/5 p-6 rounded border border-white/10"
                  >
                    <div class="text-center">
                      <p class="text-[10px] text-gray-500 uppercase">
                        Original
                      </p>
                      <p
                        id="res-old"
                        class="font-mono text-xl text-red-400 line-through"
                      >
                        0MB
                      </p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-600"></i>
                    <div class="text-center">
                      <p class="text-[10px] text-gray-500 uppercase">
                        Optimized
                      </p>
                      <p
                        id="res-new"
                        class="font-mono text-3xl text-cyber font-bold"
                      >
                        0MB
                      </p>
                    </div>
                  </div>

                  <button
                    id="dl-btn"
                    class="px-8 py-3 bg-cyber text-black font-bold font-headers hover:shadow-glow transition transform hover:scale-105 rounded-sm"
                  >
                    DOWNLOAD FILE
                  </button>
                  <button
                    onclick="location.reload()"
                    class="mt-4 text-xs text-gray-500 hover:text-white underline"
                  >
                    Process Another
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tutorial / Guide -->
      <section id="guide" class="py-24 text-center">
        <h2 class="font-headers text-3xl mb-12">MANUAL OVERRIDE</h2>
        <div class="max-w-3xl mx-auto cyber-frame p-1 bg-gray-900 aspect-video">
          <iframe
            class="w-full h-full"
            src="https://www.youtube.com/embed/dQw4w9WgXcQ?controls=0"
            title="Guide"
            frameborder="0"
          ></iframe>
        </div>

        <div
          class="mt-12 grid md:grid-cols-2 gap-6 text-left max-w-4xl mx-auto"
        >
          <div
            class="bg-white/5 p-6 rounded border border-white/5 hover:border-cyber/30 transition"
          >
            <h4 class="font-bold text-cyber mb-2">
              <i class="fas fa-question-circle"></i> Why "Turbo Mode"?
            </h4>
            <p class="text-sm text-gray-400">
              Processing HD video in a browser is slow. Turbo Mode resizes video
              to 720p, making it 5x-10x faster. Always use this for files >
              50MB.
            </p>
          </div>
          <div
            class="bg-white/5 p-6 rounded border border-white/5 hover:border-cyber/30 transition"
          >
            <h4 class="font-bold text-cyber mb-2">
              <i class="fas fa-shield-alt"></i> Is it secure?
            </h4>
            <p class="text-sm text-gray-400">
              Yes. The engine runs locally on your device using WebAssembly. No
              data is ever sent to a server.
            </p>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="border-t border-white/10 py-8 text-center bg-black">
      <p class="font-mono text-xs text-gray-600">
        TRANSCODEHUB SYSTEMS © 2025 // <span class="text-cyber">ONLINE</span>
      </p>
    </footer>

    <!-- LOGIC -->
    <script>
      // --- 1. BOOT SEQUENCE & ANIMATIONS ---

      // Remove Loader
      window.onload = () => {
        setTimeout(() => {
          const loader = document.getElementById("app-loader");
          gsap.to(loader, {
            opacity: 0,
            duration: 0.8,
            onComplete: () => loader.remove(),
          });

          // Animate Elements In
          gsap.from("nav", { y: -100, opacity: 0, duration: 1, delay: 0.5 });
          gsap.from(".hero-content", {
            x: -50,
            opacity: 0,
            duration: 1,
            delay: 0.8,
          });
        }, 1500); // Fake load time for "Pro" feel
      };

      // Live Particle Network (Optimized)
      const canvas = document.getElementById("bg-canvas");
      const ctx = canvas.getContext("2d");
      let width, height;
      let mouse = { x: null, y: null };

      const resize = () => {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
      };
      window.addEventListener("resize", resize);
      window.addEventListener("mousemove", (e) => {
        mouse.x = e.x;
        mouse.y = e.y;
      });
      resize();

      const particles = Array.from({ length: 60 }, () => ({
        x: Math.random() * width,
        y: Math.random() * height,
        vx: (Math.random() - 0.5) * 0.5,
        vy: (Math.random() - 0.5) * 0.5,
        size: Math.random() * 2 + 1,
      }));

      const animateBG = () => {
        ctx.clearRect(0, 0, width, height);

        particles.forEach((p, i) => {
          p.x += p.vx;
          p.y += p.vy;

          // Bounce
          if (p.x < 0 || p.x > width) p.vx *= -1;
          if (p.y < 0 || p.y > height) p.vy *= -1;

          // Draw Point
          ctx.fillStyle = "#00f3ff";
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          ctx.fill();

          // Connect to Mouse
          if (mouse.x) {
            const dx = p.x - mouse.x;
            const dy = p.y - mouse.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 150) {
              ctx.strokeStyle = `rgba(0, 243, 255, ${1 - dist / 150})`;
              ctx.lineWidth = 0.5;
              ctx.beginPath();
              ctx.moveTo(p.x, p.y);
              ctx.lineTo(mouse.x, mouse.y);
              ctx.stroke();
            }
          }

          // Connect to others
          for (let j = i; j < particles.length; j++) {
            const p2 = particles[j];
            const dx = p.x - p2.x;
            const dy = p.y - p2.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 100) {
              ctx.strokeStyle = `rgba(0, 243, 255, ${0.2 - dist / 500})`; // Very faint
              ctx.lineWidth = 0.2;
              ctx.beginPath();
              ctx.moveTo(p.x, p.y);
              ctx.lineTo(p2.x, p2.y);
              ctx.stroke();
            }
          }
        });
        requestAnimationFrame(animateBG);
      };
      animateBG();

      // 3D Floating Cards (GSAP + Tilt)
      const heroGfx = document.getElementById("hero-gfx");
      const images = [
        "https://images.unsplash.com/photo-1535242208474-9a2793260ca8?w=500&q=80",
        "https://images.unsplash.com/photo-1614850523459-c2f4c699c52e?w=500&q=80",
      ];

      images.forEach((src, i) => {
        const card = document.createElement("div");
        card.className =
          "absolute w-48 h-64 rounded-xl bg-cover bg-center border border-cyber/50 shadow-glow";
        card.style.backgroundImage = `url(${src})`;
        card.style.top = i * 40 + 50 + "px";
        card.style.left = i * 60 + 100 + "px";
        card.style.zIndex = 10 - i;
        heroGfx.appendChild(card);

        VanillaTilt.init(card, {
          max: 15,
          speed: 400,
          glare: true,
          "max-glare": 0.4,
        });

        gsap.from(card, {
          y: 100,
          opacity: 0,
          duration: 1,
          delay: 1 + i * 0.2,
        });
      });

      // Menu Logic
      let menuOpen = false;
      const menuBtn = document.getElementById("menu-btn");
      const mobileMenu = document.getElementById("mobile-menu");

      menuBtn.addEventListener("click", () => {
        menuOpen = !menuOpen;
        mobileMenu.classList.toggle("active");

        // Animate Hamburger
        if (menuOpen) {
          gsap.to("#bar1", { rotation: 45, y: 8, backgroundColor: "#00f3ff" });
          gsap.to("#bar2", { opacity: 0 });
          gsap.to("#bar3", {
            rotation: -45,
            y: -8,
            backgroundColor: "#00f3ff",
          });
        } else {
          gsap.to("#bar1", { rotation: 0, y: 0, backgroundColor: "white" });
          gsap.to("#bar2", { opacity: 1 });
          gsap.to("#bar3", { rotation: 0, y: 0, backgroundColor: "white" });
        }
      });

      document.querySelectorAll("#mobile-menu a").forEach((l) =>
        l.addEventListener("click", () => {
          menuOpen = false;
          mobileMenu.classList.remove("active");
          gsap.to("#bar1", { rotation: 0, y: 0 });
          gsap.to("#bar2", { opacity: 1 });
          gsap.to("#bar3", { rotation: 0, y: 0 });
        })
      );

      // --- 2. FFMPEG ENGINE (STABLE VERSION) ---

      const { createFFmpeg, fetchFile } = FFmpeg;
      let ffmpeg = null;
      let currentFile = null;

      const uiStates = {
        idle: document.getElementById("ui-idle"),
        process: document.getElementById("ui-process"),
        success: document.getElementById("ui-success"),
      };
      const term = document.getElementById("terminal");

      function log(msg) {
        const line = document.createElement("div");
        line.textContent = `> ${msg}`;
        term.appendChild(line);
        term.scrollTop = term.scrollHeight;
      }

      async function initEngine() {
        try {
          ffmpeg = createFFmpeg({
            log: true,
            logger: ({ message }) => {
              // Filter logs for cleaner UI
              if (message.includes("frame=")) {
                // Extract basic status if needed
              } else {
                log(message.substring(0, 50) + "...");
              }
            },
            corePath:
              "https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js",
          });

          await ffmpeg.load();
          log("CORE ONLINE. READY.");
        } catch (e) {
          log("CRITICAL FAILURE: " + e.message);
          alert("Engine failed to load. Use HTTPS or Localhost.");
        }
      }

      // Start engine immediately
      initEngine();

      // Input Handler
      document.getElementById("video-input").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          currentFile = file;
          // Update UI
          document.getElementById("file-status").classList.remove("hidden");
          document.getElementById("fname").textContent = file.name;
          document.getElementById("fsize").textContent =
            (file.size / (1024 * 1024)).toFixed(2) + " MB";

          // Enable Button
          const btn = document.getElementById("process-btn");
          btn.disabled = false;
          btn.textContent = "INITIALIZE SEQUENCE";
          btn.classList.remove(
            "bg-gray-800",
            "text-gray-500",
            "cursor-not-allowed"
          );
          btn.classList.add(
            "bg-cyber",
            "text-black",
            "hover:shadow-glow",
            "hover:scale-[1.02]"
          );

          log(`Target Acquired: ${file.name}`);
        }
      });

      // MAIN PROCESS
      document
        .getElementById("process-btn")
        .addEventListener("click", async () => {
          if (!ffmpeg.isLoaded() || !currentFile) return;

          const speedMode = document.getElementById("opt-speed").checked;
          const compress = document.getElementById("opt-compress").checked;
          const convert = document.getElementById("opt-convert").checked;
          const format = document.getElementById("fmt-select").value;

          // UI Switch
          uiStates.idle.classList.add("hidden");
          uiStates.process.classList.remove("hidden");
          uiStates.process.classList.add("flex");

          try {
            const inName = "input." + currentFile.name.split(".").pop();
            const outExt = convert ? format : "mp4";
            const outName = "output." + outExt;

            // 1. Write File
            ffmpeg.FS("writeFile", inName, await fetchFile(currentFile));
            log("File in memory.");

            // 2. Build Arguments
            let args = ["-i", inName];

            let filters = [];

            // SPEED MODE LOGIC (The Fix for Large Files)
            if (speedMode) {
              // Scale to 720p height, keep aspect ratio.
              // 'trunc(iw/2)*2' ensures even numbers which is required.
              // But simpler for speed mode: -2:720 ensures width is calculated auto and height is 720
              // We must ensure dimensions are divisible by 2 for libx264
              filters.push("scale=-2:720");
              log("Turbo Mode: Resizing to 720p...");
            } else {
              // Still need even numbers or it crashes
              filters.push("scale=trunc(iw/2)*2:trunc(ih/2)*2");
            }

            if (filters.length > 0) {
              args.push("-vf", filters.join(","));
            }

            // Codec settings
            args.push("-c:v", "libx264");
            args.push("-preset", "ultrafast"); // Max speed

            if (compress) {
              args.push("-crf", "28"); // Higher compression
            } else if (speedMode) {
              args.push("-crf", "24"); // Decent quality for resize
            }

            args.push(outName);

            // 3. Run
            log("Executing Transcode...");

            // Mock progress bar (FFmpeg doesn't give clean % in v0.11 easily without parsing duration)
            let fakeProgress = 0;
            const progInterval = setInterval(() => {
              fakeProgress += (100 - fakeProgress) / 50;
              if (fakeProgress > 95) fakeProgress = 95;
              document.getElementById("progress-bar").style.width =
                fakeProgress + "%";
              document.getElementById("progress-txt").textContent =
                Math.floor(fakeProgress) + "%";
            }, 500);

            await ffmpeg.run(...args);

            clearInterval(progInterval);
            document.getElementById("progress-bar").style.width = "100%";
            document.getElementById("progress-txt").textContent = "100%";

            // 4. Output
            const data = ffmpeg.FS("readFile", outName);

            // Show Success
            uiStates.process.classList.add("hidden");
            uiStates.process.classList.remove("flex");
            uiStates.success.classList.remove("hidden");
            uiStates.success.classList.add("flex");

            // Stats
            const newSize = (data.byteLength / (1024 * 1024)).toFixed(2);
            document.getElementById("res-old").textContent =
              (currentFile.size / (1024 * 1024)).toFixed(2) + "MB";
            document.getElementById("res-new").textContent = newSize + "MB";

            // Download
            const url = URL.createObjectURL(
              new Blob([data.buffer], { type: `video/${outExt}` })
            );
            document.getElementById("dl-btn").onclick = () => {
              const a = document.createElement("a");
              a.href = url;
              a.download = `transcode_${Date.now()}.${outExt}`;
              a.click();
            };
          } catch (e) {
            console.error(e);
            log("ERROR: " + e.message);
            alert("Operation Failed. Try a smaller file or refresh.");
            location.reload();
          }
        });
    </script>
  </body>
</html>
